name: Build Sing-box Rules

on:
  workflow_dispatch:
  push:
    branches: ["main"]

jobs:
  build:
    runs-on: ubuntu-latest

    permissions:
      contents: write   # Diperlukan untuk git push

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4
      with:
        persist-credentials: true
        fetch-depth: 1     # ⚡ Lebih cepat

    - name: Get latest Sing-box download URL
      id: geturl
      run: |
        URL=$(curl -s https://api.github.com/repos/SagerNet/sing-box/releases/latest \
          | grep linux-amd64.tar.gz \
          | cut -d '"' -f 4)

        {
          echo "URL<<EOF"
          echo "$URL"
          echo "EOF"
        } >> "$GITHUB_OUTPUT"

    - name: Download & Extract Sing-box (FAST)
      run: |
        wget -q "${{ steps.geturl.outputs.URL }}"
        tar -xf *.tar.gz --wildcards "*/sing-box"
        DIR=$(find . -type d -name "sing-box*" | head -n 1)
        echo "DIR=$DIR" >> $GITHUB_ENV

    - name: Compile all JSON in rules/ to SRS in root
      run: |
        for FILE in rules/*.json; do
          NAME=$(basename "$FILE" .json)
          echo "Compile: $FILE → $NAME.srs"
          "${{ env.DIR }}/sing-box" rule-set compile "$FILE" -o "$NAME.srs"
        done
        ls -lah *.srs

    - name: Upload all SRS files
      uses: actions/upload-artifact@v4
      with:
        name: hasil-singbox
        path: "*.srs"

    - name: Commit and push SRS
      run: |
        git config --global user.email "github-actions@github.com"
        git config --global user.name "GitHub Actions"
        git add *.srs
        git commit -m "Auto-update SRS (from rules/ folder)" || echo "No changes to commit"
        git push
